<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Szeker: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Szeker"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Szeker
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,true,'search.html','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__8piolibdeps_jm__scheduler__i_d1549__r_e_a_d_m_e.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">README </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="http://jean-marc.paratte.ch/wp-content/uploads/2013/01/diduino1_960x96.jpg" class="header-image" alt="jmP" height="96" width="960"/>
</div>
<h1><a class="el" href="classjm___scheduler.html">jm_Scheduler</a> - A Scheduler Library for Arduino</h1>
<div class="fragment"><div class="line">2017-10-17: v1.0.5 - Minor adjustments.</div><div class="line">2017-05-08: v1.0.4 - Minor adjustments.</div><div class="line">2017-05-08: v1.0.4 - Minor adjustments.</div><div class="line">2017-05-05: v1.0.3 - Adding <a class="code" href="jm___scheduler_8cpp.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield</a>(),sleep(),rearm_async(). Removing <span class="keywordtype">void</span> rearm(timestamp_t time, timestamp_t ival);</div><div class="line">2017-04-26: v1.0.2 - Adding <span class="keywordtype">void</span> rearm(timestamp_t time, timestamp_t ival);</div><div class="line">2017-03-29: v1.0.1 - Minor adjustments.</div><div class="line">2016-07-08: v1.0.0 - Initial commit.</div></div><!-- fragment --><h3>Concept</h3>
<p><b><a class="el" href="classjm___scheduler.html">jm_Scheduler</a></b> schedules repeated and intervaled routines like the JavaScript <code>setInterval()</code> function does, but with some improvements:</p>
<ul>
<li>By default, <b><a class="el" href="classjm___scheduler.html">jm_Scheduler</a></b> starts immediately the routine and repeats it periodically.</li>
<li>The first execution can be differed.</li>
<li>The repeated executions can be voided.</li>
<li>The interval between executions can be dynamically changed.</li>
<li>The scheduled routine function can be dynamically changed.</li>
<li>The scheduled routine can be stopped and later restarted.</li>
</ul>
<p><b><a class="el" href="classjm___scheduler.html">jm_Scheduler</a></b> doesn't schedule like the official <a href="https://www.arduino.cc/en/Reference/Scheduler"><b>Scheduler</b> Library for Arduino DUE and ZERO</a> does, <code><a class="el" href="jm___scheduler_8cpp.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield()</a></code> function which suspends a task is not implemented, <code>startLoop()</code> function which allocates a stack to the new task is not implemented.</p>
<p><b><a class="el" href="classjm___scheduler.html">jm_Scheduler</a></b> schedules tasks sequentially on the stack processor. The rules to <em>yield</em> and <em>resume</em> are:</p>
<ul>
<li><em>yield</em> comes out when routine leaves at end of function or by an explicit <code>return</code> instruction.</li>
<li><em>resume</em> to a next state can be done with a variable and a <code>switch</code> instruction. Or:</li>
<li><em>resume</em> to a next state can be done by switching to another function.</li>
<li>Persistent variables must be implemented <em>global</em> or <em>local</em> with the pragma <code>static</code>.</li>
</ul>
<h3>Basic Example</h3>
<pre class="fragment">// This example schedules a routine every second

#include &lt;jm_Scheduler.h&gt;

jm_Scheduler scheduler;

void routine()
{
    Serial.print('.');
}

void setup(void)
{
    Serial.begin(9600);

    scheduler.start(routine, TIMESTAMP_1SEC); // Start immediately routine() and repeat it every second
}

void loop(void)
{
    jm_Scheduler::cycle();
}
</pre><h3>Study Plan</h3>
<ul>
<li>Begin with example <b>Clock1.ino</b>. This example demonstrates the advantage to start immediately a time display routine and periodically repeat it.</li>
<li>Follow with examples <b>Clock2.ino</b> and <b>Clock3.ino</b> which present other timing ways.</li>
<li><b>Clock4.ino</b> example presents a usefully <b><a class="el" href="classjm___scheduler.html">jm_Scheduler</a></b> technical: changing dynamically the function to execute.</li>
<li><b>Beat1.ino</b> and <b>Beat2.ino</b> examples present interaction between 2 scheduled routines.</li>
<li><b>Wakeup1.ino</b> example demonstrates the possible interaction between an interrupt and a scheduled routine, implementing a timeout.</li>
</ul>
<h3>Timestamp</h3>
<p>The <em>timestamp</em> is read from the Arduino function <code>micros()</code>. By design, the <code>micros()</code> function of Arduino UNO and Leonardo running at 16MHz returns a [us] <em>timestamp</em> with a resolution of [4us].</p>
<p><code>micros()</code> declaration is:</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> micros();</div></div><!-- fragment --><p>Look at <a href="https://www.arduino.cc/en/Reference/Micros">https://www.arduino.cc/en/Reference/Micros</a> for details.</p>
<p><em>timestamp</em> is a 32bit [us] counter and overflows about every 70 minutes (precisely 1h+11m+34s+967ms+296us).</p>
<h3>Timestamp declaration and constants</h3>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> uint32_t timestamp_t;</div><div class="line"></div><div class="line"><span class="preprocessor">#define timestamp_read() ((timestamp_t)micros())</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define TIMESTAMP_DEAD (0x01CA0000) // routine dead time [30s + 15ms + 488us]</span></div><div class="line"><span class="preprocessor">#define TIMESTAMP_TMAX (0xFE35FFFF) // [1h + 11m + 4s + 951ms + 808us - 1]</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define TIMESTAMP_1US   (1UL)                   // [1us]</span></div><div class="line"><span class="preprocessor">#define TIMESTAMP_1MS   (1000*TIMESTAMP_1US)    // [1ms]</span></div><div class="line"><span class="preprocessor">#define TIMESTAMP_1SEC  (1000*TIMESTAMP_1MS)    // [1s]</span></div><div class="line"><span class="preprocessor">#define TIMESTAMP_1MIN  (60*TIMESTAMP_1SEC)     // [1 minute]</span></div><div class="line"><span class="preprocessor">#define TIMESTAMP_1HOUR (60*TIMESTAMP_1MIN)     // [1 hour]</span></div></div><!-- fragment --><blockquote class="doxtable">
<p><code>timestamp_t</code> defines the type of all <em>timestamp</em> values. </p>
</blockquote>
<blockquote class="doxtable">
<p><code><a class="el" href="jm___scheduler_8h.html#a4a6adfc774160c30ed1ad176ccefe65c">timestamp_read()</a></code> returns the instantaneous <em>timestamp</em>. </p>
</blockquote>
<p>This function can also be used by interrupt routines to <em>timestamp</em> they data.</p>
<blockquote class="doxtable">
<p><code>TIMESTAMP_DEAD</code> is the maximum allowed execution time of a routine to guarantee right scheduling. </p>
</blockquote>
<p>If the routine doesn't end before, the scheduler could miss very long scheduling (see next).</p>
<blockquote class="doxtable">
<p><code>TIMESTAMP_TMAX</code> is the maximum allowed scheduling time of a routine. </p>
</blockquote>
<p>In practice, don't use <em>timestamp</em> values greater than 1 hour.</p>
<h3><a class="el" href="classjm___scheduler.html">jm_Scheduler</a> methods</h3>
<div class="fragment"><div class="line"><span class="comment">// start routine immediately</span></div><div class="line"><span class="keywordtype">void</span> start(<a class="code" href="jm___scheduler_8h.html#a6e5037c7c2d7be541012f726696be40d">voidfuncptr_t</a> func);</div><div class="line"></div><div class="line"><span class="comment">// start routine immediately and repeat it at fixed interval</span></div><div class="line"><span class="keywordtype">void</span> start(<a class="code" href="jm___scheduler_8h.html#a6e5037c7c2d7be541012f726696be40d">voidfuncptr_t</a> func, timestamp_t ival);</div><div class="line"></div><div class="line"><span class="comment">// start routine on time and repeat it at fixed interval</span></div><div class="line"><span class="keywordtype">void</span> start(<a class="code" href="jm___scheduler_8h.html#a6e5037c7c2d7be541012f726696be40d">voidfuncptr_t</a> func, timestamp_t time, timestamp_t ival);</div><div class="line"></div><div class="line"><span class="comment">// stop routine, current or scheduled, remove it from chain</span></div><div class="line"><span class="keywordtype">void</span> stop();</div><div class="line"></div><div class="line"><span class="comment">// rearm current routine and set or reset interval</span></div><div class="line"><span class="keywordtype">void</span> rearm(timestamp_t ival);</div><div class="line"></div><div class="line"><span class="comment">// rearm current routine, change routine function and set or reset interval</span></div><div class="line"><span class="keywordtype">void</span> rearm(<a class="code" href="jm___scheduler_8h.html#a6e5037c7c2d7be541012f726696be40d">voidfuncptr_t</a> func, timestamp_t ival);</div></div><!-- fragment --><blockquote class="doxtable">
<p><code>start()</code> initiates a scheduler variable, starts a routine function, immediately or on time, with or without repetitions. </p>
</blockquote>
<p><code>start()</code> is invoked once. Next <code>rearm()</code> allows changing scheduler values.</p>
<blockquote class="doxtable">
<p><code>stop()</code> cancels further execution of a scheduled routine. </p>
</blockquote>
<p><code>stop()</code> can be invoked from inside routine or elsewhere. If invoked from inside <em>routine</em>, <code>stop()</code> doesn't exit the function, just cancels further execution.</p>
<blockquote class="doxtable">
<p><code>rearm()</code> changes values of a scheduler variable. </p>
</blockquote>
<p>The new values are evaluated on exit routine function. The main usage is to change <em>interval</em> or <em>function</em> or both or else cancel further execution.</p>
<h3><a class="el" href="classjm___scheduler.html">jm_Scheduler</a> loop</h3>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cycle();</div></div><!-- fragment --><blockquote class="doxtable">
<p><code>cycle()</code> is the cornerstone of the scheduler and must be invoked as often as possible. </p>
</blockquote>
<p>Note that <code>cycle()</code> is a <em>static</em> <em>method</em>. The right place is in Arduino <code><a class="el" href="main_8cpp.html#afe461d27b9c48d5921c00d521181f12f" title="General Loop function for Arduino &lt;brief&gt; ">loop()</a></code> function. Example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="main_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="classjm___scheduler.html#a868f53e5acccf503f861c4be4d0c210b">jm_Scheduler::cycle</a>();</div><div class="line">}</div></div><!-- fragment --><blockquote class="doxtable">
<p><code>cycle()</code> can also be invoked in Arduino <code><a class="el" href="main_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d" title="General Setup function for Arduino &lt;brief&gt; ">setup()</a></code> function. Example: </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="main_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">// here, some jm_Scheduler variables initialized...</span></div><div class="line"></div><div class="line">    Serial.begin(9600);</div><div class="line">    <span class="keywordflow">while</span> (!Serial)</div><div class="line">    {</div><div class="line">        <span class="comment">// wait for USB Serial ready...</span></div><div class="line"></div><div class="line">        <a class="code" href="classjm___scheduler.html#a868f53e5acccf503f861c4be4d0c210b">jm_Scheduler::cycle</a>();</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// split long setup()...</span></div><div class="line"></div><div class="line">    <a class="code" href="classjm___scheduler.html#a868f53e5acccf503f861c4be4d0c210b">jm_Scheduler::cycle</a>();</div><div class="line"></div><div class="line">    <span class="comment">// continue setup()...</span></div><div class="line">}</div></div><!-- fragment --><blockquote class="doxtable">
<p><code>cycle()</code> can't be invoked from inside a routine function. </p>
</blockquote>
<h3>Good scheduling practices</h3>
<ul>
<li>To guarantee a good scheduling of all tasks, the execution time of each function must be as short as possible.</li>
<li>Avoid Arduino <code>delay()</code> function, use <b><a class="el" href="classjm___scheduler.html">jm_Scheduler</a></b> <code>rearm()</code> method with appropriate arguments to split the routine in some serialized functions.</li>
<li>Use same technical for long calculations.</li>
</ul>
<h3>Changing of Timestamp</h3>
<p>Here are some hacks that can be implemented by modifying the file <b><a class="el" href="jm___scheduler_8h.html">jm_Scheduler.h</a></b>.</p>
<ul>
<li>Another source for the <em>timestamp</em> could be the [ms] read from the Arduino function <code>millis()</code>.</li>
<li>Gain speed during <em>timestamp</em> comparison by shortening the size to 16bit.</li>
<li>Obtain very long periodicity by implementing a 64bit <em>timestamp</em>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
